以下のREADME.mdファイルを作成しました。

```markdown
# Dobot CR3A - Modbus TCP カメラ制御システム

## 📋 概要

このプロジェクトは、Dobot CR3Aロボットアームと外部PC（AI処理用）間でModbus TCP通信を使用してカメラ撮影を制御するシステムです。

ロボットが指定位置に移動後、撮影指令を送信し、PC側でカメラ撮影（またはAI処理）を実行、完了後にロボットが次の動作に進むという協調動作を実現します。

---

## 🏗️ システム構成

```
┌─────────────────────┐         Modbus TCP          ┌──────────────────────┐
│   Dobot CR3A        │     (192.168.0.95:502)      │   外部PC (AI-PC)     │
│   (Modbus Client)   │ ◄─────────────────────────► │   (Modbus Server)    │
│                     │                              │                      │
│  - ロボット制御     │                              │  - カメラ制御        │
│  - 撮影指令送信     │                              │  - AI画像処理        │
│  - 完了待機         │                              │  - データ保存        │
└─────────────────────┘                              └──────────────────────┘
```

### ネットワーク設定
- **PC側IPアドレス**: `192.168.0.95`
- **Modbusポート**: `502` (Modbus TCP標準ポート)
- **サブネットマスク**: `255.255.255.0`

---

## 🔄 通信フロー

```
【Dobot側】                          【PC側】
    │                                   │
    │ 1. P1位置へ移動                  │
    ├──────────────────────────────────►│
    │                                   │
    │ 2. 撮影指令送信                  │
    │    (41025 = 1)                   │
    ├──────────────────────────────────►│ 3. 指令を検出
    │                                   │
    │                                   │ 4. カメラ撮影実行
    │                                   │    (2秒間処理)
    │                                   │
    │ 5. 完了待機                      │
    │    (1025 == 1 を監視)            │
    │◄──────────────────────────────────┤ 6. 完了通知送信
    │                                   │    (1025 = 1)
    │                                   │
    │ 7. 完了を検出                    │
    │                                   │
    │ 8. トリガーリセット              │
    │    (41025 = 0)                   │
    ├──────────────────────────────────►│ 9. リセット検出
    │                                   │
    │                                   │ 10. 完了フラグリセット
    │                                   │     (1025 = 0)
    │                                   │
    │ 11. 次の動作へ                   │ 12. 待機状態へ
    │                                   │
```

---

## 📡 Modbusレジスタマッピング

| レジスタ | Dobot側アドレス | PC側アドレス | 用途 | データ型 |
|---------|----------------|-------------|------|---------|
| **トリガー** | `41025` | `41025` | 撮影開始指令 (0/1) | U16 |
| **完了フラグ** | `1025` | `1025` | 撮影完了通知 (0/1) | U16 |

### アドレス変換の注意点
- Dobot側の`SetHoldRegs(id, 41025, ...)`はPLC形式アドレス（40001オフセット）
- PC側（pyModbusTCP）は内部的に変換処理を行う
- **重要**: 完了フラグの読み取りは`1025`を使用（`41026`ではない）

---

## 🖥️ PC側（Python）

### 必要環境
- Python 3.10以上
- pyModbusTCP ライブラリ

### インストール
```bash
# 仮想環境の作成（推奨）
conda create -n py310_dobot_dev python=3.10
conda activate py310_dobot_dev

# 必要なライブラリのインストール
pip install pyModbusTCP
```

### 実行方法
```bash
python 02.python-modbus-server.py
```

### コードの主要機能

#### `02.python-modbus-server.py` - メインサーバー
```python
ADDR_TRIGGER = 41025  # 撮影指令を受信するアドレス
ADDR_DONE    = 1025   # 完了通知を送信するアドレス
```

**動作フロー:**
1. Modbus TCPサーバーを起動（0.0.0.0:502で待ち受け）
2. トリガーレジスタ（41025）を50ms周期で監視
3. トリガー = 1 を検出したら撮影処理を実行
4. 完了フラグ（1025）に 1 をセット
5. Dobotからのリセット（41025 = 0）を待機
6. 完了フラグをリセット（1025 = 0）
7. 次の指令待機状態に戻る

#### `03.python-modbus-check.py` - アドレステストツール
アドレスマッピングを確認するためのデバッグツール。複数のアドレス範囲を監視し、実際にどのアドレスが変化するかをリアルタイム表示します。

---

## 🤖 Dobot側（Lua）

### 実行環境
- Dobot CR3A コントローラー
- DobotStudio Pro または Blockly環境

### スクリプトの配置
1. DobotStudioでプロジェクトを開く
2. Luaスクリプトをプロジェクトに追加
3. IP設定を確認（`192.168.0.95`）

### 実行方法
1. PC側のModbusサーバーが起動していることを確認
2. Dobot側でスクリプトを実行

### コードの主要機能

**動作フロー:**
1. Modbus接続確立（`ModbusCreate`）
2. P1位置へロボットを移動
3. 撮影トリガーを送信（`SetHoldRegs(id, 41025, 1, {1})`）
4. 完了フラグを監視（`GetHoldRegs(id, 1025, 1)`）
5. 完了検出後、トリガーをリセット（`SetHoldRegs(id, 41025, 1, {0})`）
6. 次の動作へ進む

### エラーハンドリング
- 接続失敗時はエラーコードを表示して終了
- タイムアウト（10秒）機能を実装
- 各ステップでデバッグログを出力

---

## 🚀 使用方法

### 1. 初期セットアップ

#### PC側
```bash
# 1. IPアドレスを設定
# イーサネットアダプタを192.168.0.95に設定

# 2. ファイアウォール設定
# PowerShell（管理者権限）で実行
New-NetFirewallRule -DisplayName "Python Modbus Server" `
  -Direction Inbound -Program "C:\path\to\python.exe" -Action Allow

# 3. 仮想環境を有効化
conda activate py310_dobot_dev

# 4. サーバーを起動
python 02.python-modbus-server.py
```

#### Dobot側
1. DobotとPCを同一ネットワークに接続
2. Dobotのネットワーク設定を確認
3. P1位置を教示

### 2. 動作確認

#### 正常動作時の出力例

**PC側:**
```
======================================================================
カメラシミュレーター起動
======================================================================
待ち受けアドレス: 0.0.0.0:502
トリガーアドレス: 41025
完了フラグアドレス: 1025
======================================================================
✅ サーバー起動成功

Dobotからの撮影指令を待機中...

======================================================================
[19:20:30] 📸 撮影指令を受信
======================================================================
📷 カメラ撮影処理を開始...
  処理中... 25%
  処理中... 50%
  処理中... 75%
  処理中... 100%
✅ 撮影完了。データを保存しました。
📤 完了通知を送信 (1025 = 1)

⏳ Dobotのトリガーリセットを待機中...
✅ トリガーがリセットされました
🔄 システムをリセット (1025 = 0)
======================================================================

⏸️  次の撮影指令を待機中...
```

**Dobot側:**
```
✅ Modbus接続成功 (ID: 0)

--- ロボット動作開始 ---
📍 P1位置へ移動中...
✅ 移動完了

--- 撮影処理開始 ---
📤 撮影指令を送信 (41025 = 1)
⏳ 撮影完了を待機中...
✅ 撮影完了を確認 (1025 = 1)

--- 後処理 ---
🔄 トリガーをリセット (41025 = 0)
✅ リセット完了

==========================================
  ✅ 撮影処理が正常に完了しました
==========================================
```

---

## 🛠️ トラブルシューティング

### よくある問題と解決策

#### 1. **接続失敗（Modbus接続エラー）**

**症状:**
```
❌ Modbus接続失敗
エラーコード: -1
```

**確認事項:**
- [ ] PC側のPythonサーバーが起動しているか
- [ ] IPアドレスが正しいか（`192.168.0.95`）
- [ ] DobotとPCが同じネットワークにいるか
- [ ] Windowsファイアウォールがポート502を許可しているか

**解決方法:**
```bash
# IPアドレス確認
ipconfig

# ファイアウォールルール追加
New-NetFirewallRule -DisplayName "Modbus TCP" -Direction Inbound -Protocol TCP -LocalPort 502 -Action Allow

# Pingテスト
ping 192.168.0.95
```

---

#### 2. **タイムアウト（完了フラグを受信できない）**

**症状:**
```
❌ タイムアウト (10秒経過)
現在の1025の値: 0
```

**確認事項:**
- [ ] Dobot側が`1025`から読み取っているか（`41026`ではない）
- [ ] PC側が`1025`に書き込んでいるか
- [ ] アドレスマッピングが正しいか

**デバッグ方法:**
```bash
# アドレステストツールを実行
python 03.python-modbus-check.py
```

---

#### 3. **トリガーリセットのタイムアウト**

**症状:**
```
⚠️  警告: リセットタイムアウト
```

**原因:**
- Dobot側が`SetHoldRegs(id, 41025, 1, {0})`を実行していない
- スクリプトが完了フラグ待機でエラー終了している

**解決方法:**
- Dobot側のLuaスクリプト全体が正常に実行されているか確認
- デバッグ版スクリプトで各ステップの実行を確認

---

## 📊 技術仕様

### 通信プロトコル
- **プロトコル**: Modbus TCP
- **ポーリング周期**: 50ms（両側とも）
- **タイムアウト**: 10秒
- **データ型**: U16（符号なし16ビット整数）

### パフォーマンス
- **応答時間**: 約2-3秒（撮影処理時間含む）
- **通信遅延**: <100ms
- **リトライ回数**: なし（1回のみ）

### 制限事項
- 同時接続数: 1（Dobot 1台のみ）
- レジスタ数: 2（トリガーと完了フラグ）
- ネットワーク: ローカルネットワークのみ

---

## 🔧 カスタマイズ

### 撮影処理時間の変更

**Python側:**
```python
# 現在: 2秒（0.5秒 × 4回）
for i in range(1, 5):
    time.sleep(0.5)
    
# 変更例: 5秒
for i in range(1, 11):
    time.sleep(0.5)
```

### タイムアウト時間の変更

**Lua側:**
```lua
-- 現在: 10秒（200 × 50ms）
local max_timeout = 200

-- 変更例: 30秒
local max_timeout = 600
```

### ロボット動作の追加

**Lua側:**
```lua
-- 撮影処理完了後の動作例
print("ロボット動作を継続します...")

-- P2位置へ移動
MovJ(P2)

-- 再度撮影
SetHoldRegs(id, 41025, 1, {1}, "U16")
-- （完了待機処理を再実行）
```

---

## 📁 ファイル構成

```
473.dobot_modbus_plc/
├── 02.python-modbus-server.py    # メインサーバー（本番用）
├── 03.python-modbus-check.py     # アドレステストツール（デバッグ用）
├── dobot_camera_control.lua      # Dobot側制御スクリプト
└── README.md                      # このファイル
```

---

## 🔐 セキュリティ

### 注意事項
- このシステムは**ローカルネットワーク専用**です
- インターネットに公開しないでください
- 認証機能はありません
- ファイアウォールで必要最小限のポート（502のみ）を開放してください

### 推奨設定
```bash
# 特定のIPからのみ接続を許可
New-NetFirewallRule -DisplayName "Modbus from Dobot" `
  -Direction Inbound -Protocol TCP -LocalPort 502 `
  -RemoteAddress 192.168.0.0/24 -Action Allow
```

---

## 📝 ライセンス

このプロジェクトは内部利用目的で作成されています。

---

## 👤 作成者

**Tomomi Research Inc.**  
Dr. Seong-Hun Choe (CTO)

---

## 📞 サポート

問題が発生した場合は、以下を確認してください：

1. このREADMEのトラブルシューティングセクション
2. デバッグツール（`03.python-modbus-check.py`）の実行
3. 両側のログ出力の確認

---

## 🔄 バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2026-02-07 | 初回リリース |

---

## 🎯 今後の拡張予定

- [ ] 複数カメラ対応
- [ ] 画像データの転送機能
- [ ] エラーログの自動保存
- [ ] GUI監視ツールの追加
- [ ] 複数Dobot対応
```

このREADME.mdファイルをプロジェクトフォルダに保存してください。システムの概要、使用方法、トラブルシューティングまで網羅しています。