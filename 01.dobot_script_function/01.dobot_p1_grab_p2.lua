print("==========================================")
print("  Dobot CR3A ã‚«ãƒ¡ãƒ©æ’®å½±åˆ¶å¾¡")
print("  P1æ’®å½± â†’ P2ç§»å‹• ãƒ«ãƒ¼ãƒ—")
print("==========================================")
print("æ¥ç¶šå…ˆ: 192.168.0.95:502")
print()

-- Modbusæ¥ç¶š
local resultCreate, id = ModbusCreate('192.168.0.95', 502, 1)

if resultCreate ~= 0 then
    print("âŒ Modbusæ¥ç¶šå¤±æ•—")
    print("ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:", resultCreate)
    return
end

print("âœ… Modbusæ¥ç¶šæˆåŠŸ (ID:", id, ")")
print()

-- ãƒ«ãƒ¼ãƒ—å›æ•°ã®è¨­å®š
local loop_count = 5  -- 5å›ç¹°ã‚Šè¿”ã™ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰

print(string.format("ã“ã‚Œã‹ã‚‰ %d å›ã®æ’®å½±ã‚µã‚¤ã‚¯ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™", loop_count))
print()

-- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
for i = 1, loop_count do
    print("==========================================")
    print(string.format("  ã‚µã‚¤ã‚¯ãƒ« %d / %d", i, loop_count))
    print("==========================================")
    print()
    
    -- ========================================
    -- ã‚¹ãƒ†ãƒƒãƒ—1: P1ä½ç½®ã¸ç§»å‹•
    -- ========================================
    print("[ã‚¹ãƒ†ãƒƒãƒ—1] P1ä½ç½®ã¸ç§»å‹•")
    print("ğŸ“ ç§»å‹•ä¸­...")
    MovJ(P1)
    print("âœ… P1åˆ°é”")
    print()
    
    -- ========================================
    -- ã‚¹ãƒ†ãƒƒãƒ—2: æ’®å½±æŒ‡ä»¤é€ä¿¡
    -- ========================================
    print("[ã‚¹ãƒ†ãƒƒãƒ—2] æ’®å½±æŒ‡ä»¤é€ä¿¡")
    print("ğŸ“¤ ãƒˆãƒªã‚¬ãƒ¼é€ä¿¡ (41025 = 1)")
    SetHoldRegs(id, 41025, 1, {1}, "U16")
    print("âœ… é€ä¿¡å®Œäº†")
    print()
    
    -- ========================================
    -- ã‚¹ãƒ†ãƒƒãƒ—3: æ’®å½±å®Œäº†å¾…æ©Ÿ
    -- ========================================
    print("[ã‚¹ãƒ†ãƒƒãƒ—3] æ’®å½±å®Œäº†å¾…æ©Ÿ")
    print("â³ å®Œäº†ãƒ•ãƒ©ã‚°ã‚’ç›£è¦–ä¸­...")
    
    local timeout = 0
    local max_timeout = 200  -- 10ç§’
    
    while true do
        local done_flag = GetHoldRegs(id, 41026, 1, "U16")
        
        -- æ’®å½±å®Œäº†ã‚’ç¢ºèª
        if done_flag and done_flag[1] == 1 then
            print("âœ… æ’®å½±å®Œäº†ã‚’ç¢ºèª (41026 = 1)")
            break
        end
        
        -- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
        timeout = timeout + 1
        if timeout > max_timeout then
            print("âŒ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (10ç§’çµŒé)")
            print("ç¾åœ¨ã®41026ã®å€¤:", done_flag and done_flag[1] or "nil")
            print("å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™")
            return
        end
        
        -- 2ç§’ã”ã¨ã«é€²æ—è¡¨ç¤º
        if timeout % 40 == 0 then
            local elapsed = timeout / 20
            print(string.format("  å¾…æ©Ÿä¸­... %dç§’çµŒé", elapsed))
        end
    end
    print()
    
    -- ========================================
    -- ã‚¹ãƒ†ãƒƒãƒ—4: ãƒˆãƒªã‚¬ãƒ¼ãƒªã‚»ãƒƒãƒˆ
    -- ========================================
    print("[ã‚¹ãƒ†ãƒƒãƒ—4] ãƒˆãƒªã‚¬ãƒ¼ãƒªã‚»ãƒƒãƒˆ")
    print("ğŸ”„ ãƒˆãƒªã‚¬ãƒ¼ã‚’0ã«æˆ»ã—ã¾ã™ (41025 = 0)")
    SetHoldRegs(id, 41025, 1, {0}, "U16")
    print("âœ… ãƒªã‚»ãƒƒãƒˆå®Œäº†")
    print()
    
    -- ========================================
    -- ã‚¹ãƒ†ãƒƒãƒ—5: P2ä½ç½®ã¸ç§»å‹•
    -- ========================================
    print("[ã‚¹ãƒ†ãƒƒãƒ—5] P2ä½ç½®ã¸ç§»å‹•")
    print("ğŸ“ ç§»å‹•ä¸­...")
    MovJ(P2)
    print("âœ… P2åˆ°é”")
    print()
    
    print(string.format("ã‚µã‚¤ã‚¯ãƒ« %d å®Œäº†", i))
    print()
    
    -- æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã¾ã§å°‘ã—å¾…æ©Ÿï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if i < loop_count then
        print("æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã¾ã§1ç§’å¾…æ©Ÿ...")
        local start = os.clock()
        while os.clock() - start < 1 do
            -- 1ç§’å¾…æ©Ÿ
        end
        print()
    end
end

-- ========================================
-- å…¨ã‚µã‚¤ã‚¯ãƒ«å®Œäº†
-- ========================================
print("==========================================")
print(string.format("  âœ… å…¨ %d ã‚µã‚¤ã‚¯ãƒ«å®Œäº†", loop_count))
print("==========================================")
print()

-- ãƒ›ãƒ¼ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³ã¸æˆ»ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
print("ãƒ›ãƒ¼ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³ã¸ç§»å‹•ä¸­...")
MovJ(Home)
print("âœ… ãƒ›ãƒ¼ãƒ åˆ°é”")
print()

print("ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ")
